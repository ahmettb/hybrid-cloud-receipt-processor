# AI-Powered Receipt Processing System

This project is a hybrid cloud solution that processes market receipts using AWS serverless technologies and stores structured data in an Oracle Autonomous Database.

The system utilizes Amazon Textract for OCR and Amazon Bedrock (Claude 3 Haiku) for intelligent data extraction, ensuring high accuracy in parsing receipt details.

---

## System Architecture

The infrastructure is built on a custom Virtual Private Cloud (VPC) to ensure network isolation. Public and private resources are strictly separated.

![System Architecture Diagram](https://i.hizliresim.com/ex54f2a.png)

### Core Components

- **VPC & Subnets:** The network is divided into Public and Private subnets. Application logic resides in the Private subnet with no direct internet access.
- **AWS NAT Gateway / NAT Instance:** The infrastructure code defaults to **NAT Gateway** for high availability and production standards. However, the architecture diagram depicts a **NAT Instance**, and the Terraform code includes a toggleable module for this cost-effective alternative suitable for development environments.
- **Oracle Database Security:** The database is configured with an Access Control List (ACL) that only accepts connections from the NAT Gateway's static IP.

---

## Data Flow

1. **Upload:** A receipt image is uploaded to an Amazon S3 bucket.
2. **Trigger:** The upload event triggers a Lambda function located in the Private Subnet.
3. **Processing:**
   - **Textract** extracts raw text from the image.
   - **Bedrock (Claude 3)** parses the text into a structured JSON format.
   - Traffic to these services is routed internally via VPC Endpoints.
4. **Storage:** The processed data is sent to the Oracle Autonomous Database.
5. **Security:** The connection uses mTLS (Oracle Wallet) and originates from the whitelisted NAT Gateway IP.
6. **Retrieval:** Users can query the processed data via an API Gateway endpoint.

---

## Technical Stack

- **Infrastructure:** Terraform
- **Runtime:** Python 3.12
- **Compute:** AWS Lambda
- **AI & OCR:** Amazon Bedrock (Claude 3 Haiku), Amazon Textract
- **Database:** Oracle Autonomous Database (OCI)
- **Networking:** AWS VPC, NAT Gateway, VPC Endpoints
- **Logging:** Amazon CloudWatch

---

## Deployment Guide

Follow these steps to deploy the infrastructure.

### 1. Clone the Repository

Clone the project source code to your local environment.

### 2. Configure Environment Variables

Create a `terraform.tfvars` file in the root directory to store your sensitive credentials. This file is excluded from version control.

```hcl
db_user         = "ADMIN"
db_password     = "YourStrongPassword"
db_dsn          = "db2024_high"
wallet_password = "YourWalletPassword"
```

### 3. Setup Oracle Wallet
Download the Client Credentials (Wallet) zip file from the OCI Console. Extract the contents (cwallet.sso, tnsnames.ora, etc.) into the following directories:

- lambda_source/ocr_processor/wallet/

- lambda_source/db_reader/wallet/

Note: Terraform allows these directories to be local-only. It will automatically zip them with the code during deployment.

### 4. Apply Infrastructure
Initialize and apply the Terraform configuration:
```
terraform init
terraform apply
```

### 5. Final Configuration
1. After the deployment finishes, Terraform will output a value named nat_gateway_ip.

2. Copy this IP address.

3. Navigate to your Oracle Autonomous Database settings in OCI.

4. Add the IP to the Network Access Control List (ACL).

5. Save the changes to allow connectivity.



### Database Schema
Execute the following SQL script to create the required table in your Oracle Database:
```
CREATE TABLE market_fisleri (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    magaza_adi VARCHAR2(255),
    fis_tarihi DATE,
    fis_saati VARCHAR2(10),
    toplam_tutar NUMBER(10, 2),
    kdv_tutari NUMBER(10, 2),
    odeme_tipi VARCHAR2(50),
    urun_listesi CLOB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```


### Developer Notes
- Source Packaging: Python source code and Wallet files are automatically zipped by Terraform during the apply phase.


- **NAT Strategy:** The project is configured to use a **NAT Gateway** by default to ensure maximum stability and zero maintenance. However, since NAT Gateways incur a fixed hourly cost, the `main.tf` file contains a commented-out configuration for a **NAT Instance (t2.micro)**. Developers can switch to the NAT Instance to reduce AWS costs to nearly zero during the testing phase.




## Planned Improvements

This project is designed as a learning-focused, end-to-end hybrid cloud architecture and will continue to evolve.  
Future improvements are planned to enhance security, scalability, and operational maturity, including:

- Replacing broad IAM managed policies with least-privilege custom policies
- Managing database credentials using AWS Secrets Manager or SSM Parameter Store
- Improving high availability with multi-AZ networking where applicable
- Enhancing observability beyond default CloudWatch logging (custom metrics, alarms, and dashboards)
- Reviewing cost optimization opportunities (NAT Gateway, endpoints, and service usage)

These enhancements are intentionally planned for later iterations to reflect real-world, incremental system design.
